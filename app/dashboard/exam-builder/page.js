"use client"; import { useState, useEffect } from "react"; import { useSession } from "next-auth/react"; import { toast } from "sonner"; import { Calculator, FileText, Plus, Trash2, Printer, Save, ArrowRight } from "lucide-react"; export default function ExamBuilderPage() { const { data: session } = useSession(); const [plans, setPlans] = useState([]); const [selectedPlans, setSelectedPlans] = useState([]); const [totalLessons, setTotalLessons] = useState(0); const [examTotalPoints, setExamTotalPoints] = useState(35); const [generatedExam, setGeneratedExam] = useState(null); const [loading, setLoading] = useState(false); useEffect(() => { fetch("/api/plans/search").then(r=>r.json()).then(setPlans); }, []); const addTopic = (plan) => { if (selectedPlans.find(p => p.id === plan.id)) return toast.error("Ya agregaste este tema"); const content = typeof plan.content === "string" ? JSON.parse(plan.content) : plan.content; const objectives = content.objectives ? content.objectives.join(". ") : "Tema General"; setSelectedPlans([...selectedPlans, { id: plan.id, title: plan.title, level: plan.level, content: objectives, lessons: 1 }]); }; useEffect(() => { const total = selectedPlans.reduce((acc, curr) => acc + parseInt(curr.lessons || 0), 0); setTotalLessons(total); }, [selectedPlans]); const handleGenerate = async () => { if (selectedPlans.length === 0) return toast.error("Seleccione al menos un tema"); if (totalLessons === 0) return toast.error("Defina las lecciones para calcular puntos"); setLoading(true); const toastId = toast.loading("Aplicando fórmula matemática y generando ítems..."); const topicsWithPoints = selectedPlans.map(p => ({ ...p, calculatedPoints: Math.round((p.lessons / totalLessons) * examTotalPoints) })); const currentSum = topicsWithPoints.reduce((a, b) => a + b.calculatedPoints, 0); if (currentSum !== parseInt(examTotalPoints) && topicsWithPoints.length > 0) { topicsWithPoints[0].calculatedPoints += (parseInt(examTotalPoints) - currentSum); } try { const res = await fetch("/api/exam/generate-cumulative", { method: "POST", body: JSON.stringify({ topics: topicsWithPoints, totalPoints: examTotalPoints }) }); const data = await res.json(); if (res.ok) { setGeneratedExam(data.exam); toast.success("¡Prueba Construida!", { id: toastId }); } else { toast.error("Error en el ensamblador.", { id: toastId }); } } catch (e) { toast.error("Error de conexión", { id: toastId }); } finally { setLoading(false); } }; return ( <div className="p-8 max-w-7xl mx-auto min-h-screen bg-slate-50"> {!generatedExam ? ( <div className="grid lg:grid-cols-2 gap-8"> <div className="space-y-6"> <div className="bg-white p-6 rounded-xl shadow-lg border border-slate-200"> <h2 className="text-2xl font-black text-slate-800 mb-4 flex gap-2"><Plus className="text-blue-600"/> Banco de Temas</h2> <div className="h-96 overflow-y-auto space-y-2 pr-2"> {plans.map(plan => ( <div key={plan.id} className="flex justify-between items-center p-3 border rounded-lg hover:bg-blue-50 transition-colors"> <div> <p className="font-bold text-sm">{plan.title}</p> <p className="text-xs text-slate-400">{plan.subject} | {plan.level}</p> </div> <button onClick={() => addTopic(plan)} className="btn btn-sm btn-ghost text-blue-600"><Plus/></button> </div> ))} </div> </div> </div> <div className="space-y-6"> <div className="bg-white p-6 rounded-xl shadow-lg border border-slate-200"> <h2 className="text-2xl font-black text-slate-800 mb-4 flex gap-2"><Calculator className="text-orange-600"/> Tabla de Especificaciones</h2> <div className="flex items-center gap-4 mb-6 bg-slate-100 p-4 rounded-lg"> <div> <label className="text-xs font-bold uppercase text-slate-500">Valor Total (Puntos)</label> <input type="number" value={examTotalPoints} onChange={e=>setExamTotalPoints(e.target.value)} className="input input-sm font-bold w-24 block"/> </div> <div className="text-right flex-1"> <p className="text-xs font-bold uppercase text-slate-500">Total Lecciones</p> <p className="text-xl font-black">{totalLessons}</p> </div> </div> <div className="space-y-2 mb-6"> {selectedPlans.map((topic, index) => { const pts = totalLessons > 0 ? Math.round((topic.lessons / totalLessons) * examTotalPoints) : 0; return ( <div key={index} className="flex items-center gap-3 bg-slate-50 p-2 rounded border"> <div className="flex-1"> <p className="text-sm font-bold truncate">{topic.title}</p> </div> <div className="flex items-center gap-2"> <label className="text-xs">Lecciones:</label> <input type="number" className="input input-xs input-bordered w-16 text-center" value={topic.lessons} min="1" onChange={(e) => { const newArr = [...selectedPlans]; newArr[index].lessons = parseInt(e.target.value) || 0; setSelectedPlans(newArr); }} /> </div> <div className="badge badge-neutral font-mono">{pts} pts</div> <button onClick={() => setSelectedPlans(selectedPlans.filter((_, i) => i !== index))} className="text-red-400 hover:text-red-600"><Trash2 className="w-4"/></button> </div> ); })} </div> <button onClick={handleGenerate} disabled={loading} className="btn btn-primary w-full btn-lg shadow-lg"> {loading ? "Calculando Balance..." : "Generar Prueba Maestra"} </button> </div> </div> </div> ) : ( <div className="animate-fade-in max-w-[21cm] mx-auto bg-white p-12 shadow-2xl min-h-screen"> <div className="flex justify-between mb-8 no-print"> <button onClick={() => setGeneratedExam(null)} className="btn btn-ghost">Editar Configuración</button> <button onClick={() => window.print()} className="btn btn-outline gap-2"><Printer className="w-4"/> Imprimir</button> </div> <div className="text-center border-b-2 border-black pb-4 mb-8 font-serif"> <h1 className="font-bold text-lg uppercase">Ministerio de Educación Pública</h1> <h2 className="font-bold text-md uppercase">Prueba Escrita Acumulativa</h2> <p>Valor: {examTotalPoints} puntos</p> </div> <div className="border border-black p-4 mb-8 font-serif text-sm"> <p><strong>Docente:</strong> {session?.user?.name}</p> <p><strong>Periodo:</strong> I Periodo 2026</p> <p><strong>Contenidos Evaluados:</strong> {selectedPlans.map(p => p.title).join(", ")}</p> </div> <div className="space-y-8 font-serif"> <div> <h3 className="font-bold bg-gray-100 p-2 mb-4 uppercase">I Parte. Selección Única</h3> {generatedExam.items.selection.map((item, i) => ( <div key={i} className="mb-4 break-inside-avoid"> <p className="font-bold">{i+1}. {item.split("?")[0]}?</p> <div className="pl-4 mt-1 space-y-1"> <p>A) __________________</p> <p>B) __________________</p> <p>C) __________________</p> </div> </div> ))} </div> <div> <h3 className="font-bold bg-gray-100 p-2 mb-4 uppercase">II Parte. Respuesta Corta</h3> {generatedExam.items.short_answer.map((item, i) => ( <div key={i} className="mb-4 break-inside-avoid"> <p>{item}</p> <div className="border-b border-black h-6 w-full"></div> <div className="border-b border-black h-6 w-full"></div> </div> ))} </div> <div> <h3 className="font-bold bg-gray-100 p-2 mb-4 uppercase">III Parte. Desarrollo</h3> {generatedExam.items.development.map((item, i) => ( <div key={i} className="mb-6 break-inside-avoid"> <p className="font-bold mb-2">{item}</p> <div className="border border-gray-300 rounded h-32 w-full"></div> </div> ))} </div> </div> <div className="mt-12 pt-12 border-t-4 border-dashed border-gray-300 break-before-page no-print"> <h3 className="text-red-600 font-bold text-center mb-4">--- SOLUCIONARIO (PARA USO DOCENTE) ---</h3> <pre className="bg-slate-100 p-4 rounded text-xs">{JSON.stringify(generatedExam.answer_key, null, 2)}</pre> </div> </div> )} </div> ); }