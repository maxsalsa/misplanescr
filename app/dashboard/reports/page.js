"use client"; import { useState, useEffect } from "react"; import { jsPDF } from "jspdf"; import { toast } from "sonner"; import { Download, Mail, Copy } from "lucide-react"; export default function ReportsPage() { const [groups, setGroups] = useState([]); const [selectedGroupId, setSelectedGroupId] = useState(""); const [students, setStudents] = useState([]); useEffect(() => { fetch("/api/groups/list").then(r=>r.json()).then(setGroups); }, []); useEffect(() => { if(selectedGroupId) { const g = groups.find(x=>x.id===selectedGroupId); if(g) setStudents(g.students); } }, [selectedGroupId, groups]); const generateFamilyReport = async (studentId, sendMail = false) => { const toastId = toast.loading("Procesando..."); const res = await fetch(`/api/report/family?studentId=${studentId}`); const { student, stats } = await res.json(); if (!sendMail) { const text = `ESTIMADA FAMILIA:\nReporte de ${student.nombre} ${student.apellido1}:\n- Conducta: ${stats.conductGrade}\n- Ausencias: ${stats.absences}\n- Boletas: ${stats.totalIncidents}\n\nFavor revisar Teams para detalles.`; navigator.clipboard.writeText(text); toast.success("Copiado para Teams", { id: toastId }); return; } if (sendMail) { if (!student.correo) return toast.error("Sin correo oficial", { id: toastId }); const subject = `Reporte Acad√©mico Oficial: ${student.nombre}`; const body = `Estimados encargados:\n\nSe adjunta reporte.\n\nAtentamente,\nDocente.`; window.open(`mailto:${student.correo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`); toast.success("Correo abierto", { id: toastId }); } }; return ( <div className="p-8 max-w-7xl mx-auto min-h-screen bg-slate-50"> <h1 className="text-3xl font-black text-slate-800 mb-6">Reportes Oficiales</h1> <p className="text-sm text-slate-500 mb-4">Canales autorizados: Teams y Correo MEP.</p> <div className="bg-white p-6 rounded-2xl shadow-lg border"> <select className="select select-bordered w-full mb-6" value={selectedGroupId} onChange={e=>setSelectedGroupId(e.target.value)}> <option value="">-- Seleccione Grupo --</option> {groups.map(g=><option key={g.id} value={g.id}>{g.name}</option>)} </select> {selectedGroupId && ( <div className="grid gap-2"> {students.map(s=>( <div key={s.id} className="flex justify-between items-center p-3 border rounded hover:bg-slate-50"> <div> <span className="font-bold block">{s.apellido1} {s.nombre}</span> <span className="text-xs text-slate-400">{s.correo || "Sin correo oficial"}</span> </div> <div className="flex gap-2"> <button onClick={()=>generateFamilyReport(s.id, false)} className="btn btn-sm btn-ghost gap-2 text-purple-600"><Copy className="w-4"/> Teams</button> <button onClick={()=>generateFamilyReport(s.id, true)} className="btn btn-sm btn-outline gap-2"><Mail className="w-4"/> Correo</button> </div> </div> ))} </div> )} </div> </div> ); }