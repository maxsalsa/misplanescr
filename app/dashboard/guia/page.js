"use client"; import { useState, useEffect } from "react"; import { toast } from "sonner"; import { ShieldCheck, FileText, Gavel, Trash2, Printer, Star } from "lucide-react"; import { jsPDF } from "jspdf"; import "jspdf-autotable"; export default function GuiaPage() { const [guideGroup, setGuideGroup] = useState(null); const [students, setStudents] = useState([]); const [selectedStudent, setSelectedStudent] = useState(null); const [incidents, setIncidents] = useState([]); const [type, setType] = useState("LEVE"); const [desc, setDesc] = useState(""); const [points, setPoints] = useState(1); const [action, setAction] = useState(""); useEffect(() => { fetch("/api/groups/list").then(r => r.json()).then(data => { const found = data.find(g => g.isGuide); setGuideGroup(found); if (found) { fetch(`/api/conduct?groupId=${found.id}`).then(r=>r.json()).then(setStudents); } }); }, []); const loadIncidents = async (sid) => { const res = await fetch(`/api/conduct?studentId=${sid}`); const data = await res.json(); setIncidents(data); if(guideGroup) fetch(`/api/conduct?groupId=${guideGroup.id}`).then(r=>r.json()).then(setStudents); }; const handleSelectStudent = (s) => { setSelectedStudent(s); loadIncidents(s.id); }; const calculateGrade = (incs) => { const deduction = incs ? incs.reduce((acc, curr) => acc + curr.pointsDeducted, 0) : 0; return Math.max(0, 100 - deduction); }; const createIncident = async () => { if (!desc || !points) return toast.error("Complete los datos"); const res = await fetch("/api/conduct", { method: "POST", body: JSON.stringify({ studentId: selectedStudent.id, type, description: desc, points, action }) }); if(res.ok) { toast.success("Boleta Aplicada"); loadIncidents(selectedStudent.id); setDesc(""); setAction(""); } }; const deleteIncident = async (id) => { if(!confirm("¿Borrar?")) return; await fetch(`/api/conduct?id=${id}`, { method: "DELETE" }); loadIncidents(selectedStudent.id); toast.success("Eliminada"); }; const generateActa = () => { const doc = new jsPDF(); doc.setFontSize(14); doc.text("MINISTERIO DE EDUCACIÓN PÚBLICA", 105, 20, null, null, "center"); doc.setFontSize(12); doc.text(`ACTA DE NOTAS DE CONDUCTA - GRUPO ${guideGroup.name}`, 105, 30, null, null, "center"); doc.text(`Periodo: ${new Date().getFullYear()}`, 105, 38, null, null, "center"); const tableData = students.map((s, i) => [ i + 1, s.cedula, `${s.apellido1} ${s.apellido2 || ""} ${s.nombre}`, calculateGrade(s.conductIncidents) ]); doc.autoTable({ startY: 45, head: [["#", "Cédula", "Nombre Completo", "Nota"]], body: tableData, }); doc.text("__________________________", 20, doc.lastAutoTable.finalY + 30); doc.text("Firma Profesor Guía", 20, doc.lastAutoTable.finalY + 35); doc.save(`Acta_Conducta_${guideGroup.name}.pdf`); }; if (!guideGroup) return ( <div className="p-20 text-center min-h-screen bg-slate-50"> <div className="bg-white p-10 rounded-2xl shadow-xl inline-block"> <Star className="w-16 h-16 text-yellow-400 mx-auto mb-4"/> <h2 className="text-2xl font-bold text-slate-800">No tienes Grupo Guía asignado</h2> <p className="text-slate-500 mb-6">Ve a "Mis Grupos" y marca la estrella en tu sección.</p> <a href="/dashboard/grupos" className="btn btn-primary">Ir a Mis Grupos</a> </div> </div> ); return ( <div className="p-8 max-w-7xl mx-auto min-h-screen bg-slate-50"> <div className="flex justify-between items-center mb-8"> <h1 className="text-3xl font-black text-slate-800 flex items-center gap-3"> <ShieldCheck className="text-purple-600 w-8 h-8"/> Grupo Guía: {guideGroup.name} </h1> {!selectedStudent && ( <button onClick={generateActa} className="btn btn-success text-white shadow-lg gap-2"> <Printer className="w-4 h-4"/> Generar Acta Oficial </button> )} </div> {!selectedStudent ? ( <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200"> <table className="table w-full"> <thead className="bg-slate-100 text-slate-600 uppercase text-xs"> <tr> <th>Estudiante</th> <th className="text-center">Faltas</th> <th className="text-center">Nota Actual</th> <th>Acción</th> </tr> </thead> <tbody> {students.map(s => { const grade = calculateGrade(s.conductIncidents); return ( <tr key={s.id} className="hover:bg-slate-50 transition-colors"> <td className="font-bold text-slate-700">{s.apellido1} {s.apellido2} {s.nombre}</td> <td className="text-center"> {s.conductIncidents.length > 0 ? <span className="badge badge-error text-white">{s.conductIncidents.length}</span> : <span className="text-slate-300">-</span>} </td> <td className="text-center"> <span className={`font-black text-lg ${grade < 70 ? "text-red-500" : grade < 90 ? "text-yellow-600" : "text-green-600"}`}> {grade} </span> </td> <td> <button onClick={()=>handleSelectStudent(s)} className="btn btn-sm btn-ghost text-purple-600">Ver Expediente</button> </td> </tr> ); })} </tbody> </table> </div> ) : ( <div className="grid lg:grid-cols-3 gap-8 animate-fade-in"> <div className="space-y-6"> <button onClick={()=>setSelectedStudent(null)} className="btn btn-sm btn-ghost mb-2">← Volver a la Lista</button> <div className="bg-white p-6 rounded-2xl shadow border text-center"> <h2 className="text-xl font-bold">{selectedStudent.nombre} {selectedStudent.apellido1}</h2> <div className="text-4xl font-black mt-4 mb-2 text-purple-600">{calculateGrade(incidents)}</div> <p className="text-xs uppercase text-slate-400 font-bold">Nota de Conducta</p> </div> <div className="bg-white p-6 rounded-2xl shadow border"> <h3 className="font-bold border-b pb-2 mb-4">Nueva Falta</h3> <div className="space-y-3"> <select className="select select-bordered select-sm w-full" value={type} onChange={e=>{setType(e.target.value); setPoints(e.target.value==="LEVE"?1:e.target.value==="GRAVE"?5:10)}}> <option value="LEVE">Falta Leve (1-5 pts)</option> <option value="GRAVE">Falta Grave (6-10 pts)</option> <option value="MUY_GRAVE">Muy Grave (10+ pts)</option> </select> <input type="number" className="input input-bordered input-sm w-full" value={points} onChange={e=>setPoints(e.target.value)} placeholder="Puntos"/> <textarea className="textarea textarea-bordered w-full" placeholder="Detalle..." value={desc} onChange={e=>setDesc(e.target.value)}></textarea> <button onClick={createIncident} className="btn btn-error w-full text-white btn-sm">Registrar</button> </div> </div> </div> <div className="lg:col-span-2 bg-white p-8 rounded-2xl shadow border"> <h3 className="text-xl font-bold mb-4">Historial de Boletas</h3> {incidents.length===0 ? <p>Sin faltas.</p> : incidents.map(inc => ( <div key={inc.id} className="flex justify-between p-3 border-b"> <div><span className="badge badge-sm">{inc.type}</span> <span className="font-bold ml-2">{inc.description}</span></div> <div className="flex items-center gap-4"><span className="text-red-500 font-bold">-{inc.pointsDeducted}</span><button onClick={()=>deleteIncident(inc.id)}><Trash2 className="w-4 text-slate-300 hover:text-red-500"/></button></div> </div> ))} </div> </div> )} </div> ); }