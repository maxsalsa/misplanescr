import { prisma } from "@/lib/db"; import { NextResponse } from "next/server"; import * as XLSX from "xlsx"; const clean=(t)=>t?t.toString().trim():""; export async function POST(req){const fd=await req.formData();const buf=Buffer.from(await fd.get("file").arrayBuffer());const data=XLSX.utils.sheet_to_json(XLSX.read(buf,{type:"buffer"}).Sheets[XLSX.read(buf,{type:"buffer"}).SheetNames[0]]);const g=await prisma.group.upsert({where:{userId_name_year:{userId:fd.get("userId"),name:fd.get("groupName"),year:2026}},update:{},create:{userId:fd.get("userId"),name:fd.get("groupName"),level:"General"}});let c=0;for(const r of data){const n={};Object.keys(r).forEach(k=>n[k.toLowerCase().trim()]=r[k]);if(n["nombre"]){const ced=clean(n["cedula"])||n["id"]||"TEMP-"+Math.random();let mail=clean(n["correo"]);if(!mail&&ced.indexOf("TEMP")===-1)mail=`${ced}@est.mep.go.cr`;await prisma.student.upsert({where:{groupId_cedula:{groupId:g.id,cedula:ced}},update:{adecuacion:clean(n["adecuacion"]),condition:clean(n["condicion"]),medicalNotes:clean(n["medico"]),correo:mail},create:{cedula:ced,nombre:clean(n["nombre"]),apellido1:clean(n["apellido1"]),apellido2:clean(n["apellido2"]),adecuacion:clean(n["adecuacion"]),condition:clean(n["condicion"]),medicalNotes:clean(n["medico"]),correo:mail,groupId:g.id}});c++;}}return NextResponse.json({success:true,message:c});}